#!/usr/bin/env python3
import sys
import argparse
import numpy as np
import configparser
from nanocut import *

BODYOBJECTS = {
    "0D": {
           "sphere": sphere.Sphere,
           "convex_polyhedron": polyhedron.Polyhedron,
           "cylinder": cylinder.Cylinder,
           },
    "1D": {
           "periodic_1D_cylinder": periodic_1D_cylinder.Periodic1DCylinder,
           "periodic_1D_prism": periodic_1D_prism.Periodic1DPrism,
           },
    "2D": {
           "periodic_2D_plane": periodic_2D_plane.Periodic2DPlane,
           }
    }


def parse_args():
    """Builds parser and returns parsed command line.
    
    Returns:
        Parsed command line as Namespace object.
    """
    parser = argparse.ArgumentParser(
        description="Cuts out various 0D, 1D and 2D shapes from crystals.")
    parser.add_argument("-a", "--append", action="store_true", default=False,
                        help="appends created structure to output file "
                        "(instead of overwriting it)")
    parser.add_argument("inifile", help="initialization file")
    parser.add_argument("resultxyz",
                        help="file containing resulting structure in xyz "
                        "format")
    return parser.parse_args()


def read_inifile(filename):
    """Reads configuration file and returns it as nested dictionary.
    
    Args:
        filename: Name of the file with the configuration.
    """
    ini = configparser.ConfigParser()
    try:
        configfile = open(filename, "r")
    except IOError:
        sys.exit("Error: Can't open " + filename + ".\nExiting...")
    try:
        ini.readfp(configfile)
    except configparser.Error as error:
        sys.exit("Error: Malformed ini-file:\n" + str(error) + "\nExiting...")
    configfile.close()
    return ini


def getbodies(configdict, allowed_bodies, geometry, period):
    """Initializes body object based on the input.
    
    Args:
        configdict: Dictionary with configuration options.
        allowed_bodies: Dictionary with allowed body objects.
        geometry: Geometry object.
        period: Periodicity object.
        
    Returns:
       List of initialized body objects.
    """
    bodies = []
    tmp = []
    for section in configdict:
        words = section.split(":")
        if len(words) == 2:
            tmp.append((allowed_bodies.get(words[0], None), section))
    bodies = [ 
        bodyobj(geometry, period, configdict=configdict[section])
        for bodyobj, section in tmp if bodyobj is not None ]
    if not len(bodies):
        output.error("No bodies specified.")
    return bodies


def getatomsinside(bodies, geo):
    """Selects the atoms in the final structure.
    
    Args:
        bodies: Bodies to consider (can be additive or subtractive)
        geo: Basic crystall geometry
        
    Returns:
        Cartesian position of the atoms in the final structure.
    """
    # Get boundaries of the cuboid containing all bodies
    cuboid_boundaries = np.vstack([ body.containing_cuboid()
                                      for body in bodies if body.additive ])
    cuboid_boundaries = np.array([ cuboid_boundaries.min(axis=0),
                                   cuboid_boundaries.max(axis=0)])

    # Generate lattice-cuboid and all atoms in it
    lattice_cuboid = geo.gen_cuboid(cuboid_boundaries)
    atoms_coords, atoms_idx = geo.gen_atoms(lattice_cuboid)
    atoms_inside_bodies = np.zeros(len(atoms_coords), dtype=bool)
    for body in bodies:
        tmp_atoms_inside_bodies = body.atoms_inside(atoms_coords)
        
        # Add or substract them respectively
        if body.additive:
            atoms_inside_bodies = atoms_inside_bodies + tmp_atoms_inside_bodies
        else:
            atoms_inside_bodies = (atoms_inside_bodies 
                                   + tmp_atoms_inside_bodies
                                   - tmp_atoms_inside_bodies)
    # Take only atoms flagged being inside
    return atoms_coords[atoms_inside_bodies], atoms_idx[atoms_inside_bodies]


def main():
    """Main program."""
 
    # Parse command line paramters
    args = parse_args()
    
    # Read initial file
    configdict = read_inifile(args.inifile)

    # Process crystal geometry
    geo = geometry.Geometry.fromdict(configdict)
    
    # Process periodicity
    period = periodicity.Periodicity.fromdict(geo, configdict)
    
    # Process bodies
    bodies = getbodies(configdict, BODYOBJECTS[period.period_type], geo, period)
    
    # Select atoms in the desired shape (first fold atoms into unit cell)
    atoms_coords, atoms_idx = getatomsinside(bodies, geo)

    # Fold atoms to unit cell and rotate to standard form
    period.arrange_positions(atoms_coords)
    axis_string, atoms_coords = period.rotate_coordsys(atoms_coords)

    # Write object to file
    output.write_crystal(geo,atoms_coords, atoms_idx, axis_string,
                         args.resultxyz, args.append)



if __name__ == "__main__":
    main()
